version: '3.8'

services:
  # MQTT Broker (optional, for MQTT protocol support)
  mqtt_broker:
    image: eclipse-mosquitto:2.0
    container_name: v2x_mqtt_broker
    ports:
      - "1883:1883"
    volumes:
      - mqtt_data:/mosquitto/data
      - mqtt_logs:/mosquitto/log
    networks:
      - v2x_network

  # Edge Server (UDP by default)
  edge_server:
    build:
      context: ./edge_server
      dockerfile: Dockerfile
    container_name: v2x_edge_server
    environment:
      - PROTOCOL=UDP
      - PORT=5000
    ports:
      - "5000:5000/udp"
      - "5000:5000/tcp"
    volumes:
      - ./data:/data
    networks:
      - v2x_network
    depends_on:
      - mqtt_broker
    restart: unless-stopped

  # Vehicle Node
  vehicle_node:
    build:
      context: ./vehicle_node
      dockerfile: Dockerfile
    container_name: v2x_vehicle_node
    volumes:
      - ./data:/data
      - ./vehicle_node/config.yaml:/config/config.yaml
    networks:
      - v2x_network
    depends_on:
      - edge_server
    restart: unless-stopped

  # Dashboard
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: v2x_dashboard
    ports:
      - "8501:8501"
    cap_add:
      - NET_ADMIN  # Enable network traffic shaping for test control
    volumes:
      - ./data:/data
      - ./outputs:/outputs  # Read experiment results
      - ./network_profiles:/network_profiles  # Access shell scripts
      - ./run_experiment.sh:/app/run_experiment.sh  # Mount experiment script
      - ./edge_server:/edge_server  # Import Database class
      - /var/run/docker.sock:/var/run/docker.sock  # Docker control for running analytics
    networks:
      - v2x_network
    depends_on:
      - edge_server
    restart: unless-stopped

  # Analytics (on-demand service)
  analytics:
    build:
      context: ./analytics
      dockerfile: Dockerfile
    container_name: v2x_analytics
    volumes:
      - ./data:/data
      - ./outputs:/outputs
      - ./pcaps:/pcaps
    networks:
      - v2x_network
    profiles:
      - analytics
    command: tail -f /dev/null  # Keep container running for manual execution

networks:
  v2x_network:
    driver: bridge

volumes:
  mqtt_data:
  mqtt_logs:
